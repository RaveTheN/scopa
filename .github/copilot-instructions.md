# Copilot Instructions — Scopa Card Game Tracker

## Project Overview

Italian Scopa card game **tracker** with AI move suggestions. Single-page Angular 16 frontend (`app/`) + Express.js backend proxy (`backend/`) for OpenAI API calls. Deployed to GitHub Pages (static) + Render (backend). All user-facing text is **Italian**; code identifiers and comments are English.

## Architecture

**Centralized observable state store** in `GameStateService` — a single `BehaviorSubject<GameState>` drives everything. Components never mutate state directly; they call `GameStateService` methods which use an internal `updateState(mutator)` pattern: deep-clone → mutate → auto-push history snapshot → commit + persist to localStorage. This gives **undo for free** on every state change.

```
GameStateService (state owner, BehaviorSubject<GameState>)
  ├── CardTrackerService       (stateless logic: phase transitions, captures)
  ├── LocalStorageService      (persistence, "scopa_ng_" prefix)
  ├── ProbabilityService       (derived observable: hypergeometric probabilities)
  └── AISuggestionService      (auto/manual AI query orchestrator)
        └── OpenAIService      (thin HTTP POST to backend)
```

**Data flow**: `GameStateService` exposes ~12 `readonly` derived observables via `pipe(map(...), distinctUntilChanged())`. Components subscribe with `async` pipe. `AISuggestionService` is injected with `void` in `AppComponent` to force DI instantiation of its auto-query subscription.

## Key Conventions

- **Standalone components** everywhere — no `NgModule`. Each component declares its own `imports` array.
- **`providedIn: 'root'`** for all services (tree-shakeable singletons).
- **Card IDs**: `"{suit}-{rank}"` format, e.g. `"denari-7"` — generated by `createCardId()` in `models/card.model.ts`.
- **ViewModel pattern**: Components map service state to a private `interface XxxViewModel` via `combineLatest` + `map` (see `StatsPanelComponent`, `AISuggestionPanelComponent`, `ToolbarComponent`).
- **`GameStateSnapshot` vs `GameState`**: Snapshot is the serializable board state; `GameState` extends it with `history`, `aiSuggestion`, `aiLoading`. AI state is deliberately excluded from undo.
- **Opponent hand** is tracked only as a count (`opponentCardCount: 0–3`), never card-by-card. Probabilities treat opponent cards as random draws from the unseen pool.
- **`CardTrackerService.handleCardClick()`** returns a `{ log, scopa, clearTable, switchTurn }` result object — `GameStateService` interprets these flags.

## Dev Workflow

```powershell
# Frontend (from app/)
npm install; npm start          # serves on localhost:4200, proxies /api/openai/* → localhost:8787

# Backend (from backend/)
npm install; npm start          # Express on localhost:8787, needs .env (copy .env.example)

# Tests (from app/)
npm test                        # Jasmine + Karma
```

**Build for GitHub Pages**: `npm run build` in `app/`, then copy `app/dist/scopa/*` to repo root.

### Backend Deployment (Render)

The production backend is hosted on **Render**. All variables from `backend/.env.example` are configured there with real keys:

| Variable | Purpose |
|---|---|
| `OPENAI_API_KEY` | OpenAI API key |
| `OPENAI_MODEL` | Model ID (e.g. `gpt-5-mini`) |
| `AI_MAX_OUTPUT_TOKENS` | Max response tokens (default `384`) |
| `OPENAI_REASONING_EFFORT` | `auto` / `low` / `medium` / `high` / `minimal` |
| `ALLOWED_ORIGINS` | CORS origins (GitHub Pages URL) |

The frontend's `environment.prod.ts` points directly to the Render backend URL.

## Testing Patterns

- **Service tests**: Manual `TestBed.configureTestingModule` with explicit providers; `HttpClientTestingModule` for HTTP isolation; access private methods via `(service as any).privateMethod()`.
- **Component tests**: Hand-rolled stub classes with `BehaviorSubject`-backed observables (no mocking libraries). Real `ComponentFixture` + DOM assertions via `nativeElement.textContent`.
- **Pure function tests**: Direct input/output (see `combinations.util.spec.ts`), normalize results for order-independent comparison.
- Specs exist for: `GameStateService`, `ProbabilityService`, `AISuggestionService`, `StatsPanelComponent`, `combinations.util`. Other components/services have no tests yet.
- **Backend**: No automated tests — tested manually via local requests. The backend's main job is prompt assembly and proxying to OpenAI, so manual verification is sufficient.

## Important Implementation Details

- **`findCombinations()`** (`utils/combinations.util.ts`): bitmask brute-force over all $2^n - 1$ subsets of table cards to find capture combinations matching a target rank.
- **Probability formula**: $P(\text{rank}) = 1 - \frac{\binom{N-k}{d}}{\binom{N}{d}}$ (hypergeometric, complementary counting).
- **Backend prompt**: ~100-line Italian system prompt in `server.js` with Scopa rules, strategic priorities, and strict JSON output format. Reasoning effort auto-adjusts based on game state.
- **Tiered model strategy**: Auto-queries use `gpt-4.1-mini` (fast, non-reasoning) for speed; manual queries and endgame use the user-selected reasoning model (`gpt-5-mini`/`gpt-5.2`). The frontend overrides `modelSelection` in `AISuggestionService.buildQueryInput()` based on `requestSource` and `isEndgame`.
- **Defensive normalization**: Both frontend (`loadState`/`normalizeState`) and backend validate every field with fallback defaults — always maintain this pattern when adding new state fields.
- **Auto-refill**: When turn switches ME → OPPONENT and `opponentCardCount === 0`, it auto-resets to 3 (new hand deal).
